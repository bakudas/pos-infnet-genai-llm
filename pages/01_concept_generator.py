"""
P√°gina 1: Concept Generator
Gera conceitos de jogos a partir de ideias iniciais.
"""

import streamlit as st
from PIL import Image
from typing import Optional, cast
import sys
import os

# Adiciona o diret√≥rio raiz ao path para importar os m√≥dulos utils
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from utils import GeminiClient, OnePageGDD, render_sidebar, add_to_concept_history

# --- Configura√ß√£o da p√°gina ---
st.set_page_config(layout="wide", page_title="Concept Generator - Game Concept Forge")

# --- Renderiza a sidebar ---
render_sidebar()

# --- T√≠tulo e Descri√ß√£o ---
st.title("üéÆ Concept Generator")
st.markdown("""
    Transforme sua ideia inicial em um conceito de jogo estruturado!
    Esta ferramenta gera automaticamente um One-Page GDD com core loop,
    mec√¢nicas, monetiza√ß√£o e diferenciais, al√©m de sugerir uma arte conceitual.
""")

# --- Inicializa√ß√£o do cliente Gemini ---
@st.cache_resource
def get_gemini_client():
    """Inicializa e cacheia o cliente Gemini."""
    try:
        return GeminiClient()
    except ValueError as e:
        st.error(f"Erro de configura√ß√£o: {e}")
        st.stop()

client = get_gemini_client()

# --- Fun√ß√£o para exibir o GDD de forma estruturada ---
def display_gdd_concept(gdd_data: OnePageGDD, generated_image: Optional[Image.Image] = None):
    """Exibe o GDD de forma estruturada e moderna."""
    st.subheader(f"‚ú® Conceito de Jogo: {gdd_data.get('titulo_provisorio', 'Sem T√≠tulo')}")

    # Apresenta a imagem gerada ou o placeholder
    if generated_image:
        st.image(generated_image, caption="Arte Conceitual Gerada", use_container_width=True)
    else:
        # URL de placeholder
        image_url = "https://placehold.co/600x300/007bff/ffffff?text=Arte+Conceitual+Gerada"
        st.image(image_url, caption="Arte Conceitual (Placeholder)", use_column_width=True)

    st.markdown("---")

    # Informa√ß√µes b√°sicas em colunas
    col1, col2 = st.columns(2)
    with col1:
        st.markdown(f"**G√™nero:** {gdd_data.get('genero', 'N/A')}")
        st.markdown(f"**Plataformas Alvo:** {', '.join(gdd_data.get('plataformas_alvo', ['N/A']))}")
    with col2:
        st.markdown(f"**P√∫blico-Alvo:** {', '.join(gdd_data.get('publico_alvo', ['N/A']))}")

    st.markdown("---")
    st.markdown(f"**Premissa/Conceito Central:** {gdd_data.get('premissa_conceito_central', 'N/A')}")
    st.markdown("---")

    # Core Loop
    with st.expander("üîÑ Core Loop", expanded=True):
        core_loop = gdd_data.get('core_loop', {})
        st.markdown(f"**A√ß√£o:** {core_loop.get('acao', 'N/A')}")
        st.markdown(f"**Recompensa:** {core_loop.get('recompensa', 'N/A')}")
        st.markdown(f"**Progress√£o:** {core_loop.get('progressao', 'N/A')}")

    # Mec√¢nicas Principais
    with st.expander("‚öôÔ∏è Mec√¢nicas Principais"):
        mecanicas = gdd_data.get('mecanicas_principais', [])
        if mecanicas:
            for mec in mecanicas:
                st.markdown(f"**{mec.get('nome', 'N/A')}**: {mec.get('descricao', 'N/A')}")
        else:
            st.markdown("Nenhuma mec√¢nica principal detalhada.")

    # Monetiza√ß√£o Opcional
    if gdd_data.get('monetizacao_opcional'):
        with st.expander("üí∞ Monetiza√ß√£o Opcional"):
            monetizacoes = gdd_data.get('monetizacao_opcional', [])
            if monetizacoes:
                for mon in monetizacoes:
                    st.markdown(f"**{mon.get('tipo', 'N/A')}**: {mon.get('descricao', 'N/A')}")
            else:
                st.markdown("Nenhuma op√ß√£o de monetiza√ß√£o sugerida.")

    # Pontos de Venda √önicos (USPs)
    with st.expander("üåü Pontos de Venda √önicos (USPs)"):
        usps = gdd_data.get('pontos_de_venda_unicos_usps', [])
        if usps:
            for usp in usps:
                st.markdown(f"- {usp}")
        else:
            st.markdown("Nenhum USP detalhado.")

    st.markdown("---")
    st.info("Esta √© uma minuta de One-Page GDD gerada por IA. Use-a como ponto de partida para seu design!")

# --- Instru√ß√µes do Modelo Gemini ---
system_instruction = """
Voc√™ √© um "Arquiteto de Conceitos de Jogo", uma intelig√™ncia artificial especializada em transformar ideias iniciais de usu√°rios em conceitos de jogo estruturados. Sua fun√ß√£o principal √©:

1. **Analisar a Ideia Central:** Compreender a ess√™ncia da ideia do usu√°rio para o jogo.
2. **Desenvolver o Core Loop:** Descrever o ciclo fundamental de atividades que o jogador repetir√° no jogo, incluindo A√ß√£o, Recompensa e Progress√£o.
3. **Propor Mec√¢nicas de Jogo:** Detalhar as regras e sistemas que governam a intera√ß√£o do jogador com o mundo do jogo e seus elementos.
4. **Elaborar uma Minuta de One-Page GDD:** Gerar um documento conciso que resuma os elementos chave do conceito.

**Restri√ß√µes e Diretrizes:**
* Mantenha a concis√£o e a clareza. O objetivo √© uma "minuta" de GDD de uma p√°gina.
* Concentre-se em conceitos jog√°veis e vi√°veis.
* Evite jarg√µes excessivos sem explica√ß√£o.
* Se a ideia do usu√°rio for vaga, fa√ßa suposi√ß√µes razo√°veis e criativas para preencher as lacunas.
* Sempre retorne o conceito de jogo estruturado e a minuta do GDD.
"""

# --- Interface principal ---
st.markdown("### üí° Conte sua ideia de jogo")
ideia = st.text_area(
    "Descreva sua ideia de jogo aqui:",
    placeholder="Ex: Um jogo de cartas onde os jogadores constroem baralhos baseados em personagens hist√≥ricos do Rio de Janeiro...",
    height=150
)

# Op√ß√µes avan√ßadas
with st.expander("‚öôÔ∏è Op√ß√µes Avan√ßadas"):
    generate_image = st.checkbox("Gerar arte conceitual", value=True)
    model_choice = st.selectbox(
        "Modelo Gemini:",
        ["gemini-2.5-flash", "gemini-1.5-flash"],
        index=0
    )

# --- Bot√£o de processamento ---
if st.button("üöÄ Gerar Conceito", type="primary") and ideia:
    with st.spinner("Estou gerando um conceito incr√≠vel para o seu jogo..."):
        try:
            # Gera o conceito
            gdd_data = client.generate_content(
                prompt=ideia,
                system_instruction=system_instruction,
                response_schema={
                    "type": "object",
                    "properties": {
                        "titulo_provisorio": {"type": "string"},
                        "genero": {"type": "string"},
                        "plataformas_alvo": {"type": "array", "items": {"type": "string"}},
                        "premissa_conceito_central": {"type": "string"},
                        "publico_alvo": {"type": "array", "items": {"type": "string"}},
                        "core_loop": {
                            "type": "object",
                            "properties": {
                                "acao": {"type": "string"},
                                "recompensa": {"type": "string"},
                                "progressao": {"type": "string"}
                            }
                        },
                        "mecanicas_principais": {
                            "type": "array",
                            "items": {
                                "type": "object",
                                "properties": {
                                    "nome": {"type": "string"},
                                    "descricao": {"type": "string"}
                                }
                            }
                        },
                        "monetizacao_opcional": {
                            "type": "array",
                            "items": {
                                "type": "object",
                                "properties": {
                                    "tipo": {"type": "string"},
                                    "descricao": {"type": "string"}
                                }
                            }
                        },
                        "pontos_de_venda_unicos_usps": {"type": "array", "items": {"type": "string"}}
                    }
                },
                model=model_choice
            )

            gdd_data: OnePageGDD = cast(OnePageGDD, gdd_data)

            # Gera imagem se solicitado
            image_generated = None
            if generate_image:
                with st.spinner("Gerando arte conceitual..."):
                    image_generated = client.generate_image(
                        f"arte conceitual do jogo: {gdd_data['premissa_conceito_central']}"
                    )

            # Exibe o resultado
            display_gdd_concept(gdd_data, image_generated)

            # Salva na sess√£o
            st.session_state['current_gdd'] = gdd_data
            st.session_state['current_concept'] = ideia

            # Adiciona ao hist√≥rico
            add_to_concept_history(
                gdd_data.get('titulo_provisorio', 'Sem t√≠tulo'),
                gdd_data,
                ideia
            )

        except Exception as e:
            st.error(f"Erro ao gerar conceito: {e}")
            st.info("Verifique se sua chave de API est√° configurada corretamente.")

# --- Se√ß√£o de ajuda ---
with st.expander("‚ùì Como usar"):
    st.markdown("""
    **Para obter melhores resultados:**

    1. **Seja espec√≠fico:** Descreva o g√™nero, mec√¢nicas principais e p√∫blico-alvo
    2. **Mencione inspira√ß√µes:** Cite jogos similares que voc√™ admira
    3. **Defina o contexto:** Explique onde e como o jogo seria jogado
    4. **Pense na experi√™ncia:** Descreva como o jogador deve se sentir

    **Exemplo de boa descri√ß√£o:**
    > "Um jogo de estrat√©gia por turnos onde jogadores gerenciam uma cidade medieval.
    > Inspirado em Civilization e Age of Empires, mas focado em constru√ß√£o e diplomacia.
    > P√∫blico-alvo: jogadores casuais de 25-40 anos que gostam de estrat√©gia sem complexidade excessiva."
    """)

# --- Hist√≥rico de conceitos ---
if 'concept_history' in st.session_state and st.session_state.concept_history:
    with st.expander("üìö Hist√≥rico de Conceitos"):
        for i, concept in enumerate(st.session_state.concept_history):
            st.markdown(f"**{i+1}. {concept['title']}** - {concept['date']}")
            if st.button(f"Carregar conceito {i+1}", key=f"load_{i}"):
                st.session_state['current_gdd'] = concept['gdd']
                st.session_state['current_concept'] = concept['concept']
                st.rerun()